"""
Ð¢Ð¾Ñ‡ÐºÐ° Ð²Ñ…Ð¾Ð´Ð° Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° RAG ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹.
Ð”ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐµÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ð²ÑÐµÐ³Ð¾ Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½Ð°.
"""

from rag.rag_pipeline import RecipeRAGPipeline

def main():
    """
    ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ RAG Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½Ð°.
    """
    print("ðŸ½ï¸ Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ RAG Ð”Ð›Ð¯ ÐŸÐžÐ˜Ð¡ÐšÐ Ð Ð•Ð¦Ð•ÐŸÐ¢ÐžÐ’")
    print("=" * 50)
    print("Ð¢ÐµÑ…Ð½Ð¾Ð»Ð¾Ð³Ð¸Ð¸:")
    print(f"ðŸ“Š Ð’ÐµÐºÑ‚Ð¾Ñ€Ð½Ð°Ñ Ð‘Ð”: FAISS")  
    print(f"ðŸ”¤ Ð­Ð¼Ð±ÐµÐ´Ð´Ð¸Ð½Ð³Ð¸: {"sentence-transformers/distiluse-base-multilingual-cased"}")
    print(f"ðŸ¤– LLM: {"Qwen/Qwen2.5-1.5B-Instruct"}")
    print(f"ðŸ” Ð“Ð¸Ð±Ñ€Ð¸Ð´Ð½Ñ‹Ð¹ Ð¿Ð¾Ð¸ÑÐº: Ð’ÐµÐºÑ‚Ð¾Ñ€Ð½Ñ‹Ð¹ + BM25")
    print("=" * 50)
    
    try:
        # Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ RAG Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½
        rag = RecipeRAGPipeline()
        
        # ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ (Ð¼Ð¾Ð¶ÐµÑ‚ Ð·Ð°Ð½ÑÑ‚ÑŒ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¼Ð¸Ð½ÑƒÑ‚)
        print("\nâ³ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¼Ð¾Ð¶ÐµÑ‚ Ð·Ð°Ð½ÑÑ‚ÑŒ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¼Ð¸Ð½ÑƒÑ‚...")
        rag.initialize_full_pipeline(
            max_recipes=200,      # ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ  
            force_rebuild=False   # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÐºÑÑˆ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ
        )
        
        print("\nðŸŽ‰ Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð³Ð¾Ñ‚Ð¾Ð²Ð° Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ!")
        print("\nÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²:")
        print("â€¢ 'ÐšÐ°Ðº Ð¿Ñ€Ð¸Ð³Ð¾Ñ‚Ð¾Ð²Ð¸Ñ‚ÑŒ Ð±Ð¾Ñ€Ñ‰?'")
        print("â€¢ 'Ð ÐµÑ†ÐµÐ¿Ñ‚ ÑÐ°Ð»Ð°Ñ‚Ð° Ñ ÐºÑƒÑ€Ð¸Ñ†ÐµÐ¹'") 
        print("â€¢ 'Ð§Ñ‚Ð¾ Ð¼Ð¾Ð¶Ð½Ð¾ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ Ð¸Ð· ÐºÐ°Ñ€Ñ‚Ð¾Ñ„ÐµÐ»Ñ?'")
        print("â€¢ 'ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ Ð´ÐµÑÐµÑ€Ñ‚'")
        print("\nÐ’Ð²ÐµÐ´Ð¸Ñ‚Ðµ 'Ð²Ñ‹Ñ…Ð¾Ð´' Ð´Ð»Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ")
        print("-" * 50)
        
        # Ð˜Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼
        while True:
            try:
                # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
                question = input("\nâ“ Ð’Ð°Ñˆ Ð²Ð¾Ð¿Ñ€Ð¾Ñ: ").strip()
                
                if not question:
                    continue
                    
                if question.lower() in ['Ð²Ñ‹Ñ…Ð¾Ð´', 'exit', 'quit', 'q']:
                    print("ðŸ‘‹ Ð”Ð¾ ÑÐ²Ð¸Ð´Ð°Ð½Ð¸Ñ!")
                    break
                
                # ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð·Ð°Ð¿Ñ€Ð¾Ñ
                result = rag.ask(question)
                
                # Ð’Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½ÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ
                print(f"\nðŸ’¬ ÐžÑ‚Ð²ÐµÑ‚ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹:")
                print(f"{result['answer']}")
                
                if result['search_results']:
                    print(f"\nðŸ“š ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ {result['found_recipes']} Ñ€ÐµÐ»ÐµÐ²Ð°Ð½Ñ‚Ð½Ñ‹Ñ… Ñ€ÐµÑ†ÐµÐ¿Ñ‚Ð¾Ð²:")
                    
                    for i, recipe in enumerate(result['search_results'], 1):
                        print(f"\n{i}. **{recipe['name']}**")
                        print(f"   ðŸ¥• Ð˜Ð½Ð³Ñ€ÐµÐ´Ð¸ÐµÐ½Ñ‚Ñ‹: {recipe['ingredients'][:100]}...")
                        if recipe['url']:
                            print(f"   ðŸ”— Ð¡ÑÑ‹Ð»ÐºÐ°: {recipe['url']}")
                        print(f"   ðŸ“Š Ð ÐµÐ»ÐµÐ²Ð°Ð½Ñ‚Ð½Ð¾ÑÑ‚ÑŒ: {recipe['relevance_score']:.3f}")
                
                # Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°
                timing = result['timing'] 
                print(f"\nâ±ï¸ Ð’Ñ€ÐµÐ¼Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸: {timing['total_time']}Ñ")
                print(f"   (Ð¿Ð¾Ð¸ÑÐº: {timing['search_time']}Ñ)")
                
                print("-" * 50)
                
            except KeyboardInterrupt:
                print("\n\nðŸ‘‹ Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ Ð¿Ð¾ Ctrl+C")
                break
            except Exception as e:
                print(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: {e}")
                continue
    
    except Exception as e:
        print(f"\nâŒ ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°: {e}")
        print("\nÐ’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ñ‹:")
        print("1. ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ñ„Ð°Ð¹Ð» Ð´Ð°Ð½Ð½Ñ‹Ñ… data/raw/recipes.json")
        print("2. ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¿Ð°Ð¼ÑÑ‚Ð¸ Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹")
        print("3. ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ (ÑÐ¼. requirements)")
        print("4. ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð¾Ð¼ Ðº HuggingFace Hub")
        
        return 1
    
    return 0


def run_batch_demo():
    """
    Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸ÑŽ Ð² Ð¿Ð°ÐºÐµÑ‚Ð½Ð¾Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼Ðµ Ñ Ð¿Ñ€ÐµÐ´ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°Ð¼Ð¸.
    """
    print("ðŸ§ª Ð”Ð•ÐœÐž Ð Ð•Ð–Ð˜Ðœ - ÐŸÐÐšÐ•Ð¢ÐÐžÐ• Ð¢Ð•Ð¡Ð¢Ð˜Ð ÐžÐ’ÐÐÐ˜Ð•")
    print("=" * 50)
    
    try:
        # Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½
        rag = RecipeRAGPipeline()
        rag.initialize_full_pipeline(max_recipes=100, force_rebuild=False)
        
        # Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹
        demo_questions = [
            "ÐšÐ°Ðº Ð¿Ñ€Ð¸Ð³Ð¾Ñ‚Ð¾Ð²Ð¸Ñ‚ÑŒ ÐºÑ€Ð°ÑÐ½Ñ‹Ð¹ Ð±Ð¾Ñ€Ñ‰?",
            "ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ Ñ€ÐµÑ†ÐµÐ¿Ñ‚ ÑÐ°Ð»Ð°Ñ‚Ð° Ñ†ÐµÐ·Ð°Ñ€ÑŒ",
            "Ð§Ñ‚Ð¾ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ñ€Ð¸Ð³Ð¾Ñ‚Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¸Ð· ÐºÑƒÑ€Ð¸Ñ†Ñ‹ Ð±Ñ‹ÑÑ‚Ñ€Ð¾?",
            "Ð”ÐµÑÐµÑ€Ñ‚ Ñ ÑÐ±Ð»Ð¾ÐºÐ°Ð¼Ð¸ Ð´Ð»Ñ Ð´ÐµÑ‚ÐµÐ¹",
            "Ð’ÐµÐ³ÐµÑ‚Ð°Ñ€Ð¸Ð°Ð½ÑÐºÐ¸Ð¹ ÑÑƒÐ¿ Ñ Ð¾Ð²Ð¾Ñ‰Ð°Ð¼Ð¸"
        ]
        
        print(f"\nðŸ” Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ {len(demo_questions)} Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð²:")
        
        for i, question in enumerate(demo_questions, 1):
            print(f"\n--- Ð¢ÐµÑÑ‚ {i}/{len(demo_questions)} ---")
            
            result = rag.ask(question)
            
            print(f"ðŸ¥˜ Ð¢Ð¾Ð¿-3 Ñ€ÐµÑ†ÐµÐ¿Ñ‚Ð°:")
            for j, recipe in enumerate(result['search_results'], 1):
                print(f"  {j}. {recipe['name']} ({recipe['relevance_score']:.3f})")
        
        print(f"\nâœ… Ð”ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!")
        
    except Exception as e:
        print(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð´ÐµÐ¼Ð¾: {e}")


if __name__ == "__main__":
    import sys
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð½Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¸
    if len(sys.argv) > 1 and sys.argv[1] == "--demo":
        run_batch_demo()
    else:
        exit_code = main()
        sys.exit(exit_code)